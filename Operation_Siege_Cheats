-- Settings
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "Sour Patch Operation Siege",
    LoadingTitle = "Sour Patch Operation Siege",
    LoadingSubtitle = "by Jrminalga",
    Theme = "Default",
    ConfigurationSaving = {
       Enabled = true,
       FolderName = nil,
       FileName = "Big Hub"
    },
    Discord = {
       Enabled = false,
       Invite = "noinvitelink",
       RememberJoins = true
    },
    KeySystem = false,
    KeySettings = {
       Title = "Untitled",
       Subtitle = "Key System",
       Note = "No method of obtaining the key is provided",
       FileName = "Key",
       SaveKey = true,
       GrabKeyFromSite = false,
       Key = {"Hello"}
    }
})

local MainTab = Window:CreateTab("Main", 4483362458)
local UItab = Window:CreateTab("Visuals", 4483362458)
local ThemesTab = Window:CreateTab("Themes", 4483362458)
local SettingsTab = Window:CreateTab("Settings", 4483362458)
local UpdatesTab = Window:CreateTab("Updates", 4483362458)

local SettingsConfigSection = SettingsTab:CreateSection("Config Settings")
-- Add a button to save the current configuration
local SaveButton = SettingsTab:CreateButton({
    Name = "Save Current Configuration",
    Callback = function()
        Rayfield:SaveConfiguration()
        Rayfield:Notify({
            Title = "Configuration Saved!",
            Content = "Your settings have been saved successfully.",
            Duration = 3,
            Image = 4483362458
        })
    end,
})

-- Add a button to load the saved configuration
local LoadButton = SettingsTab:CreateButton({
    Name = "Load Saved Configuration",
    Callback = function()
        Rayfield:LoadConfiguration()
        Rayfield:Notify({
            Title = "Configuration Loaded",
            Content = "Your settings have been loaded successfully.",
            Duration = 3,
            Image = 4483362458
        })
    end,
})

-- Theme Selector Dropdown
local ThemeDropdown = ThemesTab:CreateDropdown({
    Name = "Select Theme",
    Options = {
        "Default", 
        "Amber Glow", 
        "Amethyst", 
        "Bloom", 
        "Dark Blue", 
        "Green", 
        "Light", 
        "Ocean", 
        "Serenity"
    },
    CurrentOption = {"Default"},
    MultipleOptions = false,
    Flag = "ThemeSelector",
    Callback = function(Selected)
        local themeMap = {
            ["Default"] = "Default",
            ["Amber Glow"] = "AmberGlow",
            ["Amethyst"] = "Amethyst",
            ["Bloom"] = "Bloom",
            ["Dark Blue"] = "DarkBlue",
            ["Green"] = "Green",
            ["Light"] = "Light",
            ["Ocean"] = "Ocean",
            ["Serenity"] = "Serenity"
        }
        
        local themeIdentifier = themeMap[Selected[1]]
        Window.ModifyTheme(themeIdentifier)
    end,
 })

local Label = UpdatesTab:CreateLabel("fixed ESP fps bug", 4483362458, Color3.fromRGB(255, 255, 255), false) -- Title, Icon, Color, IgnoreTheme
local Label = UpdatesTab:CreateLabel("able to save a config in settings tab", 4483362458, Color3.fromRGB(255, 255, 255), false) -- Title, Icon, Color, IgnoreTheme
local Label = UpdatesTab:CreateLabel("Fixed themes", 4483362458, Color3.fromRGB(255, 255, 255), false) -- Title, Icon, Color, IgnoreTheme

-- Add this in the UItab section, before or after the other ESP sections
local PlayerESPSection = UItab:CreateSection("Player ESP Settings")

-- Player ESP settings
local playerESPSettings = {
    Enabled = false,
    FillColor = Color3.fromRGB(175, 25, 255),
    OutlineColor = Color3.fromRGB(255, 255, 255),
    FillTransparency = 0.5,
    OutlineTransparency = 0,
    DepthMode = "AlwaysOnTop",
    RainbowMode = false,
    RainbowSpeed = 1,
    ShowNameTags = true,
    NameTagSize = 14
}

local CoreGui = game:FindService("CoreGui")
local Players = game:FindService("Players")
local lp = Players.LocalPlayer
local connections = {}
local rainbowHue = 0

local Storage = Instance.new("Folder")
Storage.Parent = CoreGui
Storage.Name = "Highlight_Storage"

-- Function to get the enemy team of the local player
local function getEnemyTeam()
    -- Replace these with the actual team names in your game
    local ATTACKER_TEAM = "Attackers"
    local DEFENDER_TEAM = "Defenders"
    
    if not lp.Team then return nil end
    
    if lp.Team.Name == ATTACKER_TEAM then
        return DEFENDER_TEAM
    elseif lp.Team.Name == DEFENDER_TEAM then
        return ATTACKER_TEAM
    end
    
    return nil
end

-- Function to check if a player is on the enemy team
local function isEnemy(plr)
    if not plr.Team then return false end
    local enemyTeam = getEnemyTeam()
    if not enemyTeam then return false end
    
    return plr.Team.Name == enemyTeam
end

-- Function to update rainbow colors
local function updateRainbowColors()
    if not playerESPSettings.RainbowMode then return end
    
    rainbowHue = (rainbowHue + 0.01 * playerESPSettings.RainbowSpeed) % 1
    local rainbowColor = Color3.fromHSV(rainbowHue, 1, 1)
    
    for _, highlight in ipairs(Storage:GetChildren()) do
        if highlight:IsA("Highlight") then
            highlight.FillColor = rainbowColor
        end
    end
    
    -- Update name tag colors too if rainbow mode is on
    if playerESPSettings.ShowNameTags then
        for _, billboard in ipairs(Storage:GetChildren()) do
            if billboard:IsA("BillboardGui") then
                billboard.Frame.TextLabel.TextColor3 = rainbowColor
            end
        end
    end
end

-- Rainbow update connection
local rainbowConnection
local function setupRainbowUpdate()
    if rainbowConnection then
        rainbowConnection:Disconnect()
        rainbowConnection = nil
    end
    
    if playerESPSettings.Enabled and playerESPSettings.RainbowMode then
        rainbowConnection = game:GetService("RunService").Heartbeat:Connect(function()
            updateRainbowColors()
        end)
    end
end

local function createNameTag(plr, character)
    if not playerESPSettings.ShowNameTags then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = plr.Name .. "_NameTag"
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 1
    billboard.Size = UDim2.new(0, 100, 0, 40)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.Adornee = character:WaitForChild("Head")
    billboard.Parent = Storage
    
    local frame = Instance.new("Frame")
    frame.BackgroundTransparency = 1
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.Parent = billboard
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Name = "TextLabel"
    textLabel.Text = plr.Name
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextStrokeTransparency = 0.5
    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextScaled = false
    textLabel.TextSize = playerESPSettings.NameTagSize
    textLabel.TextColor3 = playerESPSettings.RainbowMode and Color3.fromHSV(rainbowHue, 1, 1) or playerESPSettings.FillColor
    textLabel.Parent = frame
    
    return billboard
end

local function Highlight(plr)
    if not playerESPSettings.Enabled then return end
    if plr == lp then return end -- Don't highlight local player
    if not isEnemy(plr) then return end -- Only highlight enemies
    
    -- Create highlight
    local Highlight = Instance.new("Highlight")
    Highlight.Name = plr.Name
    Highlight.FillColor = playerESPSettings.RainbowMode and Color3.fromHSV(rainbowHue, 1, 1) or playerESPSettings.FillColor
    Highlight.DepthMode = Enum.HighlightDepthMode[playerESPSettings.DepthMode]
    Highlight.FillTransparency = playerESPSettings.FillTransparency
    Highlight.OutlineColor = playerESPSettings.OutlineColor
    Highlight.OutlineTransparency = playerESPSettings.OutlineTransparency
    Highlight.Parent = Storage
    
    -- Create name tag
    local nameTag
    
    local function setupCharacter(char)
        if char then
            Highlight.Adornee = char
            if playerESPSettings.ShowNameTags then
                nameTag = createNameTag(plr, char)
            end
        end
    end
    
    local plrchar = plr.Character
    setupCharacter(plrchar)

    connections[plr] = {
        charAdded = plr.CharacterAdded:Connect(function(char)
            setupCharacter(char)
        end),
        charRemoving = plr.CharacterRemoving:Connect(function()
            if nameTag then
                nameTag:Destroy()
                nameTag = nil
            end
        end)
    }
end

local function updateNameTags()
    for _, item in ipairs(Storage:GetChildren()) do
        if item:IsA("BillboardGui") then
            local textLabel = item.Frame.TextLabel
            if textLabel then
                textLabel.TextSize = playerESPSettings.NameTagSize
            end
        end
    end
end

local function setupPlayerESP()
    if playerESPSettings.Enabled then
        -- Clear existing highlights and name tags
        for i, v in pairs(Storage:GetChildren()) do
            if v:IsA("Highlight") or v:IsA("BillboardGui") then
                v:Destroy()
            end
        end
        
        -- Disconnect existing connections
        for plr, connTable in pairs(connections) do
            if connTable.charAdded then connTable.charAdded:Disconnect() end
            if connTable.charRemoving then connTable.charRemoving:Disconnect() end
        end
        connections = {}
        
        -- Setup new highlights for existing players
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= lp then
                Highlight(player)
            end
        end
        
        -- Connect to new players joining
        Players.PlayerAdded:Connect(Highlight)
        
        -- Setup rainbow update if needed
        setupRainbowUpdate()
    else
        -- Clean up when disabled
        Storage:ClearAllChildren()
        for plr, connTable in pairs(connections) do
            if connTable.charAdded then connTable.charAdded:Disconnect() end
            if connTable.charRemoving then connTable.charRemoving:Disconnect() end
        end
        connections = {}
        
        if rainbowConnection then
            rainbowConnection:Disconnect()
            rainbowConnection = nil
        end
    end
end

Players.PlayerRemoving:Connect(function(plr)
    local plrname = plr.Name
    if Storage[plrname] then
        Storage[plrname]:Destroy()
    end
    if Storage[plrname .. "_NameTag"] then
        Storage[plrname .. "_NameTag"]:Destroy()
    end
    if connections[plr] then
        if connections[plr].charAdded then connections[plr].charAdded:Disconnect() end
        if connections[plr].charRemoving then connections[plr].charRemoving:Disconnect() end
    end
end)

-- Main toggle
UItab:CreateToggle({
    Name = "Player ESP",
    CurrentValue = playerESPSettings.Enabled,
    Flag = "PlayerESPEnabled",
    Callback = function(Value)
        playerESPSettings.Enabled = Value
        setupPlayerESP()
    end,
})

-- Name tags toggle
UItab:CreateToggle({
    Name = "Show Name Tags",
    CurrentValue = playerESPSettings.ShowNameTags,
    Flag = "PlayerESPShowNameTags",
    Callback = function(Value)
        playerESPSettings.ShowNameTags = Value
        if playerESPSettings.Enabled then
            setupPlayerESP()
        end
    end,
})

-- Name tag size slider
UItab:CreateSlider({
    Name = "Name Tag Size",
    Range = {8, 24},
    Increment = 1,
    Suffix = "px",
    CurrentValue = playerESPSettings.NameTagSize,
    Flag = "PlayerESPNameTagSize",
    Callback = function(Value)
        playerESPSettings.NameTagSize = Value
        updateNameTags()
    end,
})

-- Rainbow mode toggle
UItab:CreateToggle({
    Name = "Player Rainbow ESP",
    CurrentValue = playerESPSettings.RainbowMode,
    Flag = "PlayerRainbowMode",
    Callback = function(Value)
        playerESPSettings.RainbowMode = Value
        setupRainbowUpdate()
        
        -- Update all highlights with the new color mode
        for _, item in ipairs(Storage:GetChildren()) do
            if item:IsA("Highlight") then
                item.FillColor = Value and Color3.fromHSV(rainbowHue, 1, 1) or playerESPSettings.FillColor
            elseif item:IsA("BillboardGui") and item.Frame.TextLabel then
                item.Frame.TextLabel.TextColor3 = Value and Color3.fromHSV(rainbowHue, 1, 1) or playerESPSettings.FillColor
            end
        end
    end,
})

-- Rainbow speed slider
UItab:CreateSlider({
    Name = "Player Rainbow Speed",
    Range = {0.5, 3},
    Increment = 0.1,
    Suffix = "x",
    CurrentValue = playerESPSettings.RainbowSpeed,
    Flag = "PlayerRainbowSpeed",
    Callback = function(Value)
        playerESPSettings.RainbowSpeed = Value
    end,
})

-- Fill color picker
UItab:CreateColorPicker({
    Name = "Player ESP Fill Color",
    Color = playerESPSettings.FillColor,
    Flag = "PlayerESPFillColor",
    Callback = function(Value)
        playerESPSettings.FillColor = Value
        if not playerESPSettings.RainbowMode then
            for _, item in ipairs(Storage:GetChildren()) do
                if item:IsA("Highlight") then
                    item.FillColor = Value
                elseif item:IsA("BillboardGui") and item.Frame.TextLabel then
                    item.Frame.TextLabel.TextColor3 = Value
                end
            end
        end
    end
})

-- Outline color picker
UItab:CreateColorPicker({
    Name = "Player ESP Outline Color",
    Color = playerESPSettings.OutlineColor,
    Flag = "PlayerESPOutlineColor",
    Callback = function(Value)
        playerESPSettings.OutlineColor = Value
        for _, highlight in ipairs(Storage:GetChildren()) do
            if highlight:IsA("Highlight") then
                highlight.OutlineColor = Value
            end
        end
    end
})

-- Fill transparency slider
UItab:CreateSlider({
    Name = "Player ESP Fill Transparency",
    Range = {0, 1},
    Increment = 0.05,
    Suffix = "",
    CurrentValue = playerESPSettings.FillTransparency,
    Flag = "PlayerESPFillTransparency",
    Callback = function(Value)
        playerESPSettings.FillTransparency = Value
        for _, highlight in ipairs(Storage:GetChildren()) do
            if highlight:IsA("Highlight") then
                highlight.FillTransparency = Value
            end
        end
    end,
})

-- Outline transparency slider
UItab:CreateSlider({
    Name = "Player ESP Outline Transparency",
    Range = {0, 1},
    Increment = 0.05,
    Suffix = "",
    CurrentValue = playerESPSettings.OutlineTransparency,
    Flag = "PlayerESPOutlineTransparency",
    Callback = function(Value)
        playerESPSettings.OutlineTransparency = Value
        for _, highlight in ipairs(Storage:GetChildren()) do
            if highlight:IsA("Highlight") then
                highlight.OutlineTransparency = Value
            end
        end
    end,
})

-- Initialize ESP if enabled by default
if playerESPSettings.Enabled then
    setupPlayerESP()
end



--DroneESP
local DroneESPSection = UItab:CreateSection("Drone ESP Settings")

-- Drone ESP settings
local droneESPSettings = {
    Enabled = false,
    Color = Color3.fromRGB(255, 50, 50),
    Transparency = 0.4,
    MaxDistance = 1000,
    RainbowMode = false,
    RainbowSpeed = 1,
    ShowNames = true, -- New setting for name labels
    NameSize = 18 -- New setting for name size
}

local espObjects = {}
local rainbowHue = 0
local heartbeatConnection

-- Function to create highlight ESP and name label
local function createDroneESP(droneModel)
    if espObjects[droneModel] then return end -- Already exists
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "DroneESP_Highlight"
    highlight.Adornee = droneModel
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.FillTransparency = droneESPSettings.Transparency
    highlight.OutlineTransparency = 0
    highlight.FillColor = droneESPSettings.RainbowMode and Color3.fromHSV(rainbowHue, 1, 1) or droneESPSettings.Color
    highlight.OutlineColor = Color3.new(0, 0, 0)
    highlight.Parent = droneModel

    -- Create name label
    local nameLabel = Instance.new("BillboardGui")
    nameLabel.Name = "DroneESP_Name"
    nameLabel.Adornee = droneModel:FindFirstChild("HumanoidRootPart") or droneModel.PrimaryPart or droneModel:FindFirstChildWhichIsA("BasePart", true)
    nameLabel.Size = UDim2.new(0, 200, 0, 50)
    nameLabel.StudsOffset = Vector3.new(0, 2.5, 0)
    nameLabel.AlwaysOnTop = true
    nameLabel.MaxDistance = droneESPSettings.MaxDistance
    nameLabel.Enabled = droneESPSettings.ShowNames

    local textLabel = Instance.new("TextLabel")
    textLabel.Name = "Label"
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = "Drone"
    textLabel.TextColor3 = droneESPSettings.RainbowMode and Color3.fromHSV(rainbowHue, 1, 1) or droneESPSettings.Color
    textLabel.TextSize = droneESPSettings.NameSize
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextStrokeTransparency = 0
    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    textLabel.Parent = nameLabel

    nameLabel.Parent = droneModel

    espObjects[droneModel] = {
        highlight = highlight,
        nameLabel = nameLabel,
        textLabel = textLabel,
        connection = droneModel.AncestryChanged:Connect(function()
            if not droneModel or not droneModel.Parent then
                removeDroneESP(droneModel)
            end
        end)
    }
end

-- Function to remove ESP
local function removeDroneESP(droneModel)
    if espObjects[droneModel] then
        if espObjects[droneModel].highlight then
            espObjects[droneModel].highlight:Destroy()
        end
        if espObjects[droneModel].nameLabel then
            espObjects[droneModel].nameLabel:Destroy()
        end
        if espObjects[droneModel].connection then
            espObjects[droneModel].connection:Disconnect()
        end
        espObjects[droneModel] = nil
    end
end

-- Cleanup function
local function cleanUpDroneESP()
    for droneModel, _ in pairs(espObjects) do
        if not droneModel or not droneModel.Parent then
            removeDroneESP(droneModel)
        end
    end
end

-- Main scanning function
local function scanForDrones()
    if not droneESPSettings.Enabled then return end
    
    -- Find drones folder dynamically (case insensitive)
    local dronesFolder
    for _, child in ipairs(workspace:GetDescendants()) do
        if child.Name:lower() == "drones" and child:IsA("Folder") then
            dronesFolder = child
            break
        end
    end

    if not dronesFolder then return end

    -- Scan all drone models
    for _, item in ipairs(dronesFolder:GetChildren()) do
        if item:IsA("Model") then
            local mesh = item:FindFirstChild("Drone") or item:FindFirstChildWhichIsA("BasePart", true)
            if mesh and not espObjects[item] then
                createDroneESP(item)
            end
        end
    end

    cleanUpDroneESP()
end

-- Distance-based visibility update
local function updateDroneESPVisibility()
    if not droneESPSettings.Enabled or not localPlayer.Character then return end
    local rootPart = localPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    for droneModel, esp in pairs(espObjects) do
        if droneModel and droneModel.Parent then
            local primaryPart = droneModel:FindFirstChild("HumanoidRootPart") or droneModel.PrimaryPart or droneModel:FindFirstChildWhichIsA("BasePart", true)
            if primaryPart then
                local distance = (rootPart.Position - primaryPart.Position).Magnitude
                local visible = distance <= droneESPSettings.MaxDistance
                
                if esp.highlight then
                    esp.highlight.Enabled = visible
                end
                
                if esp.nameLabel then
                    esp.nameLabel.Enabled = visible and droneESPSettings.ShowNames
                    esp.nameLabel.MaxDistance = droneESPSettings.MaxDistance
                end
                
                -- Update rainbow color if enabled
                if droneESPSettings.RainbowMode then
                    local color = Color3.fromHSV(rainbowHue, 1, 1)
                    if esp.highlight then
                        esp.highlight.FillColor = color
                    end
                    if esp.textLabel then
                        esp.textLabel.TextColor3 = color
                    end
                end
            end
        else
            removeDroneESP(droneModel)
        end
    end
end

-- Rainbow color update
local function updateRainbow(delta)
    if droneESPSettings.RainbowMode then
        rainbowHue = (rainbowHue + delta * 0.25 * droneESPSettings.RainbowSpeed) % 1
        for _, esp in pairs(espObjects) do
            local color = Color3.fromHSV(rainbowHue, 1, 1)
            if esp.highlight then
                esp.highlight.FillColor = color
            end
            if esp.textLabel then
                esp.textLabel.TextColor3 = color
            end
        end
    end
end

-- Setup main loop
local function setupDroneESP()
    for droneModel, _ in pairs(espObjects) do
        removeDroneESP(droneModel)
    end
    
    if droneESPSettings.Enabled and not droneESPOriginalState then
        droneESPOriginalState = true
    end
    
    local localPlayer = game.Players.LocalPlayer
    if localPlayer and localPlayer.Team then
        currentTeam = localPlayer.Team.Name
        if currentTeam == "Attackers" then
            if heartbeatConnection then
                heartbeatConnection:Disconnect()
                heartbeatConnection = nil
            end
            return
        end
    end
    
    if droneESPOriginalState then
        droneESPSettings.Enabled = true
        scanForDrones()
        
        if not heartbeatConnection then
            heartbeatConnection = game:GetService("RunService").Heartbeat:Connect(function(delta)
                updateRainbow(delta)
                scanForDrones()
                updateDroneESPVisibility()
            end)
        end
    else
        if heartbeatConnection then
            heartbeatConnection:Disconnect()
            heartbeatConnection = nil
        end
    end
end

local function checkTeamChange()
    local localPlayer = game.Players.LocalPlayer
    if not localPlayer then return end
    
    localPlayer:GetPropertyChangedSignal("Team"):Connect(function()
        if localPlayer.Team then
            local newTeam = localPlayer.Team.Name
            if newTeam ~= currentTeam then
                currentTeam = newTeam
                if droneESPOriginalState then
                    if newTeam == "Defenders" then
                        setupDroneESP()
                    elseif newTeam == "Attackers" then
                        for droneModel, _ in pairs(espObjects) do
                            removeDroneESP(droneModel)
                        end
                        if heartbeatConnection then
                            heartbeatConnection:Disconnect()
                            heartbeatConnection = nil
                        end
                    end
                end
            end
        end
    end)
end

checkTeamChange()

-- Main toggle
UItab:CreateToggle({
    Name = "Drone ESP",
    CurrentValue = droneESPSettings.Enabled,
    Flag = "DroneESPEnabled",
    Callback = function(Value)
        droneESPSettings.Enabled = Value
        if Value then
            droneESPOriginalState = true
        else
            droneESPOriginalState = false
        end
        setupDroneESP()
    end,
})

-- Color picker
UItab:CreateColorPicker({
    Name = "Drone ESP Color",
    Color = droneESPSettings.Color,
    Flag = "DroneESPColor",
    Callback = function(Value)
        droneESPSettings.Color = Value
        if not droneESPSettings.RainbowMode then
            for _, esp in pairs(espObjects) do
                if esp.highlight then
                    esp.highlight.FillColor = Value
                end
                if esp.textLabel then
                    esp.textLabel.TextColor3 = Value
                end
            end
        end
    end
})

-- Transparency slider
UItab:CreateSlider({
    Name = "Drone ESP Transparency",
    Range = {0, 1},
    Increment = 0.05,
    Suffix = "",
    CurrentValue = droneESPSettings.Transparency,
    Flag = "DroneESPTransparency",
    Callback = function(Value)
        droneESPSettings.Transparency = Value
        for _, esp in pairs(espObjects) do
            if esp.highlight then
                esp.highlight.FillTransparency = Value
            end
        end
    end,
})

-- Max distance slider
UItab:CreateSlider({
    Name = "Drone ESP Distance",
    Range = {100, 2000},
    Increment = 50,
    Suffix = " studs",
    CurrentValue = droneESPSettings.MaxDistance,
    Flag = "DroneESPDistance",
    Callback = function(Value)
        droneESPSettings.MaxDistance = Value
    end,
})

-- Rainbow mode toggle
UItab:CreateToggle({
    Name = "Drone Rainbow ESP",
    CurrentValue = droneESPSettings.RainbowMode,
    Flag = "DroneRainbowMode",
    Callback = function(Value)
        droneESPSettings.RainbowMode = Value
        for _, esp in pairs(espObjects) do
            if esp.highlight then
                esp.highlight.FillColor = Value and Color3.fromHSV(rainbowHue, 1, 1) or droneESPSettings.Color
            end
            if esp.textLabel then
                esp.textLabel.TextColor3 = Value and Color3.fromHSV(rainbowHue, 1, 1) or droneESPSettings.Color
            end
        end
    end,
})

-- Rainbow speed slider
UItab:CreateSlider({
    Name = "Drone Rainbow Speed",
    Range = {0.5, 3},
    Increment = 0.1,
    Suffix = "x",
    CurrentValue = droneESPSettings.RainbowSpeed,
    Flag = "DroneRainbowSpeed",
    Callback = function(Value)
        droneESPSettings.RainbowSpeed = Value
    end,
})

-- Name label toggle
UItab:CreateToggle({
    Name = "Show Drone Names",
    CurrentValue = droneESPSettings.ShowNames,
    Flag = "DroneESPShowNames",
    Callback = function(Value)
        droneESPSettings.ShowNames = Value
        for _, esp in pairs(espObjects) do
            if esp.nameLabel then
                esp.nameLabel.Enabled = Value
            end
        end
    end,
})

-- Name size slider
UItab:CreateSlider({
    Name = "Drone Name Size",
    Range = {10, 30},
    Increment = 1,
    Suffix = "px",
    CurrentValue = droneESPSettings.NameSize,
    Flag = "DroneESPNameSize",
    Callback = function(Value)
        droneESPSettings.NameSize = Value
        for _, esp in pairs(espObjects) do
            if esp.textLabel then
                esp.textLabel.TextSize = Value
            end
        end
    end,
})

local GadgetESPSection = UItab:CreateSection("Gadget ESP Settings")

-- Gadget ESP settings
local gadgetESPSettings = {
    Enabled = false,
    Color = Color3.fromRGB(50, 50, 255),  -- Blue color for gadgets
    Transparency = 0.4,
    MaxDistance = 1000,
    RainbowMode = false,
    RainbowSpeed = 1,
    ShowNames = true,
    NameSize = 18
}

local espObjects = {}
local rainbowHue = 0
local heartbeatConnection
local currentTeam = ""
local gadgetESPOriginalState = false

-- Function to create highlight ESP for gadgets
local function createGadgetESP(gadget)
    if espObjects[gadget] then return end -- Already exists
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "GadgetESP_Highlight"
    highlight.Adornee = gadget
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.FillTransparency = gadgetESPSettings.Transparency
    highlight.OutlineTransparency = 0
    highlight.FillColor = gadgetESPSettings.RainbowMode and Color3.fromHSV(rainbowHue, 1, 1) or gadgetESPSettings.Color
    highlight.OutlineColor = Color3.new(0, 0, 0)
    highlight.Parent = gadget

    -- Create name label
    local nameLabel = Instance.new("BillboardGui")
    nameLabel.Name = "GadgetESP_Name"
    nameLabel.Adornee = gadget:IsA("BasePart") and gadget or gadget:FindFirstChildWhichIsA("BasePart", true)
    nameLabel.Size = UDim2.new(0, 200, 0, 50)
    nameLabel.StudsOffset = Vector3.new(0, 2.5, 0)
    nameLabel.AlwaysOnTop = true
    nameLabel.MaxDistance = gadgetESPSettings.MaxDistance
    nameLabel.Enabled = gadgetESPSettings.ShowNames

    local textLabel = Instance.new("TextLabel")
    textLabel.Name = "Label"
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = gadget.Name  -- Use the actual gadget name instead of "Gadget"
    textLabel.TextColor3 = gadgetESPSettings.RainbowMode and Color3.fromHSV(rainbowHue, 1, 1) or gadgetESPSettings.Color
    textLabel.TextSize = gadgetESPSettings.NameSize
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextStrokeTransparency = 0
    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    textLabel.Parent = nameLabel

    nameLabel.Parent = gadget

    espObjects[gadget] = {
        highlight = highlight,
        nameLabel = nameLabel,
        textLabel = textLabel,
        connection = gadget.AncestryChanged:Connect(function()
            if not gadget or not gadget.Parent then
                removeGadgetESP(gadget)
            end
        end)
    }
end

-- Function to remove ESP
local function removeGadgetESP(gadget)
    if espObjects[gadget] then
        if espObjects[gadget].highlight then
            espObjects[gadget].highlight:Destroy()
        end
        if espObjects[gadget].nameLabel then
            espObjects[gadget].nameLabel:Destroy()
        end
        if espObjects[gadget].connection then
            espObjects[gadget].connection:Disconnect()
        end
        espObjects[gadget] = nil
    end
end

-- Cleanup function
local function cleanUpGadgetESP()
    for gadget, _ in pairs(espObjects) do
        if not gadget or not gadget.Parent then
            removeGadgetESP(gadget)
        end
    end
end

-- Main scanning function
local function scanForGadgets()
    if not gadgetESPSettings.Enabled then return end
    
    -- Find gadgets folder
    local gadgetsFolder = workspace:FindFirstChild("Gadgets")
    if not gadgetsFolder then return end

    -- Scan all gadgets
    for _, gadget in ipairs(gadgetsFolder:GetChildren()) do
        if (gadget:IsA("Model") or gadget:IsA("BasePart")) and not espObjects[gadget] then
            createGadgetESP(gadget)
        end
    end

    cleanUpGadgetESP()
end

-- Distance-based visibility update
local function updateGadgetESPVisibility()
    if not gadgetESPSettings.Enabled or not localPlayer or not localPlayer.Character then return end
    local rootPart = localPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    for gadget, esp in pairs(espObjects) do
        if gadget and gadget.Parent then
            local primaryPart = gadget:IsA("BasePart") and gadget or gadget:FindFirstChildWhichIsA("BasePart", true)
            if primaryPart then
                local distance = (rootPart.Position - primaryPart.Position).Magnitude
                local visible = distance <= gadgetESPSettings.MaxDistance
                
                if esp.highlight then
                    esp.highlight.Enabled = visible
                end
                
                if esp.nameLabel then
                    esp.nameLabel.Enabled = visible and gadgetESPSettings.ShowNames
                    esp.nameLabel.MaxDistance = gadgetESPSettings.MaxDistance
                end
                
                -- Update rainbow color if enabled
                if gadgetESPSettings.RainbowMode then
                    local color = Color3.fromHSV(rainbowHue, 1, 1)
                    if esp.highlight then
                        esp.highlight.FillColor = color
                    end
                    if esp.textLabel then
                        esp.textLabel.TextColor3 = color
                    end
                end
            end
        else
            removeGadgetESP(gadget)
        end
    end
end

-- Rainbow color update
local function updateRainbow(delta)
    if gadgetESPSettings.RainbowMode then
        rainbowHue = (rainbowHue + delta * 0.25 * gadgetESPSettings.RainbowSpeed) % 1
        for _, esp in pairs(espObjects) do
            local color = Color3.fromHSV(rainbowHue, 1, 1)
            if esp.highlight then
                esp.highlight.FillColor = color
            end
            if esp.textLabel then
                esp.textLabel.TextColor3 = color
            end
        end
    end
end

-- Setup main loop
local function setupGadgetESP()
    for gadget, _ in pairs(espObjects) do
        removeGadgetESP(gadget)
    end
    
    if gadgetESPSettings.Enabled and not gadgetESPOriginalState then
        gadgetESPOriginalState = true
    end
    
    local localPlayer = game.Players.LocalPlayer
    if localPlayer and localPlayer.Team then
        currentTeam = localPlayer.Team.Name
        if currentTeam ~= "Attackers" then
            if heartbeatConnection then
                heartbeatConnection:Disconnect()
                heartbeatConnection = nil
            end
            return
        end
    end
    
    if gadgetESPOriginalState then
        gadgetESPSettings.Enabled = true
        scanForGadgets()
        
        if not heartbeatConnection then
            heartbeatConnection = game:GetService("RunService").Heartbeat:Connect(function(delta)
                updateRainbow(delta)
                scanForGadgets()
                updateGadgetESPVisibility()
            end)
        end
    else
        if heartbeatConnection then
            heartbeatConnection:Disconnect()
            heartbeatConnection = nil
        end
    end
end

local function checkTeamChange()
    local localPlayer = game.Players.LocalPlayer
    if not localPlayer then return end
    
    localPlayer:GetPropertyChangedSignal("Team"):Connect(function()
        if localPlayer.Team then
            local newTeam = localPlayer.Team.Name
            if newTeam ~= currentTeam then
                currentTeam = newTeam
                if gadgetESPOriginalState then
                    if newTeam == "Attackers" then
                        setupGadgetESP()
                    else
                        for gadget, _ in pairs(espObjects) do
                            removeGadgetESP(gadget)
                        end
                        if heartbeatConnection then
                            heartbeatConnection:Disconnect()
                            heartbeatConnection = nil
                        end
                    end
                end
            end
        end
    end)
end

-- Initialize
checkTeamChange()

-- Main toggle
UItab:CreateToggle({
    Name = "Gadget ESP",
    CurrentValue = gadgetESPSettings.Enabled,
    Flag = "GadgetESPEnabled",
    Callback = function(Value)
        gadgetESPSettings.Enabled = Value
        if Value then
            gadgetESPOriginalState = true
        else
            gadgetESPOriginalState = false
        end
        setupGadgetESP()
    end,
})

-- Color picker
UItab:CreateColorPicker({
    Name = "Gadget ESP Color",
    Color = gadgetESPSettings.Color,
    Flag = "GadgetESPColor",
    Callback = function(Value)
        gadgetESPSettings.Color = Value
        if not gadgetESPSettings.RainbowMode then
            for _, esp in pairs(espObjects) do
                if esp.highlight then
                    esp.highlight.FillColor = Value
                end
                if esp.textLabel then
                    esp.textLabel.TextColor3 = Value
                end
            end
        end
    end
})

-- Transparency slider
UItab:CreateSlider({
    Name = "Gadget ESP Transparency",
    Range = {0, 1},
    Increment = 0.05,
    Suffix = "",
    CurrentValue = gadgetESPSettings.Transparency,
    Flag = "GadgetESPTransparency",
    Callback = function(Value)
        gadgetESPSettings.Transparency = Value
        for _, esp in pairs(espObjects) do
            if esp.highlight then
                esp.highlight.FillTransparency = Value
            end
        end
    end,
})

-- Max distance slider
UItab:CreateSlider({
    Name = "Gadget ESP Distance",
    Range = {100, 2000},
    Increment = 50,
    Suffix = " studs",
    CurrentValue = gadgetESPSettings.MaxDistance,
    Flag = "GadgetESPDistance",
    Callback = function(Value)
        gadgetESPSettings.MaxDistance = Value
    end,
})

-- Rainbow mode toggle
UItab:CreateToggle({
    Name = "Gadget Rainbow ESP",
    CurrentValue = gadgetESPSettings.RainbowMode,
    Flag = "GadgetRainbowMode",
    Callback = function(Value)
        gadgetESPSettings.RainbowMode = Value
        for _, esp in pairs(espObjects) do
            if esp.highlight then
                esp.highlight.FillColor = Value and Color3.fromHSV(rainbowHue, 1, 1) or gadgetESPSettings.Color
            end
            if esp.textLabel then
                esp.textLabel.TextColor3 = Value and Color3.fromHSV(rainbowHue, 1, 1) or gadgetESPSettings.Color
            end
        end
    end,
})

-- Rainbow speed slider
UItab:CreateSlider({
    Name = "Gadget Rainbow Speed",
    Range = {0.5, 3},
    Increment = 0.1,
    Suffix = "x",
    CurrentValue = gadgetESPSettings.RainbowSpeed,
    Flag = "GadgetRainbowSpeed",
    Callback = function(Value)
        gadgetESPSettings.RainbowSpeed = Value
    end,
})

-- Name label toggle
UItab:CreateToggle({
    Name = "Show Gadget Names",
    CurrentValue = gadgetESPSettings.ShowNames,
    Flag = "GadgetESPShowNames",
    Callback = function(Value)
        gadgetESPSettings.ShowNames = Value
        for _, esp in pairs(espObjects) do
            if esp.nameLabel then
                esp.nameLabel.Enabled = Value
            end
        end
    end,
})

-- Name size slider
UItab:CreateSlider({
    Name = "Gadget Name Size",
    Range = {10, 30},
    Increment = 1,
    Suffix = "px",
    CurrentValue = gadgetESPSettings.NameSize,
    Flag = "GadgetESPNameSize",
    Callback = function(Value)
        gadgetESPSettings.NameSize = Value
        for _, esp in pairs(espObjects) do
            if esp.textLabel then
                esp.textLabel.TextSize = Value
            end
        end
    end,
})

local Teleportsection = MainTab:CreateSection("Teleport")
local Input = MainTab:CreateInput({
    Name = "Player Username",
    PlaceholderText = "Enter username",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        -- Store the input text in targetUsername
        targetUsername = Text
    end,
})

local Button = MainTab:CreateButton({
    Name = "Teleport to Player",
    Callback = function()
        local players = game:GetService("Players")
        local targetPlayer = players:FindFirstChild(targetUsername)
        
        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local localPlayer = players.LocalPlayer
            if localPlayer.Character then
                localPlayer.Character:MoveTo(targetPlayer.Character.HumanoidRootPart.Position)
                Rayfield:Notify({
                    Title = "Teleport Success",
                    Content = "Teleported to "..targetUsername,
                    Duration = 3,
                    Image = 4483362458,
                })
            else
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Your character doesn't exist",
                    Duration = 3,
                    Image = 4483362458,
                })
            end
        else
            Rayfield:Notify({
                Title = "Error",
                Content = "Player not found or doesn't have character",
                Duration = 3,
                Image = 4483362458,
            })
        end
    end,
})

-- Add this in the MainTab section
local SpeedSection = MainTab:CreateSection("Speed Settings")

local walkSpeedSettings = {
    Enabled = false,  -- Master switch for the feature
    Active = false,   -- Whether speed is currently applied
    Speed = 50,       -- Default speed value
    ToggleKey = Enum.KeyCode.F
}

-- Function to update walk speed
local function updateWalkSpeed()
    if not game.Players.LocalPlayer or not game.Players.LocalPlayer.Character then return end
    
    local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("Humanoid")
    if humanoid then
        if walkSpeedSettings.Enabled and walkSpeedSettings.Active then
            sethiddenproperty(humanoid, "WalkSpeed", walkSpeedSettings.Speed)
        else
            sethiddenproperty(humanoid, "WalkSpeed", 16) -- Default speed
        end
    end
end

-- Main toggle switch
local SpeedToggle = MainTab:CreateToggle({
    Name = "Enable Speed Feature",
    CurrentValue = walkSpeedSettings.Enabled,
    Flag = "WalkSpeedEnabled",
    Callback = function(Value)
        walkSpeedSettings.Enabled = Value
        walkSpeedSettings.Active = Value -- Turn on when enabling
        updateWalkSpeed()
        
        Rayfield:Notify({
            Title = "Speed Feature " .. (Value and "Enabled" or "Disabled"),
            Content = Value and "Press "..tostring(walkSpeedSettings.ToggleKey).." to toggle" or "Speed reset to default",
            Duration = 2,
            Image = 4483362458,
        })
    end,
})

-- Speed slider
MainTab:CreateSlider({
    Name = "Speed Value",
    Range = {16, 150},
    Increment = 1,
    Suffix = " studs",
    CurrentValue = walkSpeedSettings.Speed,
    Flag = "WalkSpeedValue",
    Callback = function(Value)
        walkSpeedSettings.Speed = Value
        if walkSpeedSettings.Enabled and walkSpeedSettings.Active then
            updateWalkSpeed()
        end
    end,
})

-- Keybind setup
local SpeedKeybind = MainTab:CreateKeybind({
    Name = "Toggle Speed Keybind",
    CurrentKeybind = walkSpeedSettings.ToggleKey,
    HoldToInteract = false,
    Flag = "WalkSpeedKeybind",
    Callback = function(Key)
        walkSpeedSettings.ToggleKey = Key
        Rayfield:Notify({
            Title = "Speed Keybind Updated",
            Content = "Press "..tostring(Key).." to toggle speed",
            Duration = 2,
            Image = 4483362458,
        })
    end,
})

-- Keybind listener
local function handleKeybind(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == walkSpeedSettings.ToggleKey and walkSpeedSettings.Enabled then
        walkSpeedSettings.Active = not walkSpeedSettings.Active
        updateWalkSpeed()
        
        Rayfield:Notify({
            Title = "Speed " .. (walkSpeedSettings.Active and "ON" or "OFF"),
            Content = walkSpeedSettings.Active and ("Speed: "..walkSpeedSettings.Speed) or "Default speed",
            Duration = 1.5,
            Image = 4483362458,
        })
    end
end

-- Initialize
game:GetService("UserInputService").InputBegan:Connect(handleKeybind)

-- Handle character changes
game.Players.LocalPlayer.CharacterAdded:Connect(function(character)
    character:WaitForChild("Humanoid")
    if walkSpeedSettings.Enabled then
        updateWalkSpeed()
    end
end)

-- Cleanup
Rayfield:DestroySignal():Connect(function()
    if rainbowConnection then
        rainbowConnection:Disconnect()
    end
    -- Clean up player connections
    for player, connTable in pairs(connections) do
        if connTable.charAdded then connTable.charAdded:Disconnect() end
        if connTable.charRemoving then connTable.charRemoving:Disconnect() end
    end
    connections = {}
end)

-- Cleanup
Rayfield:DestroySignal():Connect(function()
    -- Reset speed when script is destroyed
    if game.Players.LocalPlayer.Character then
        local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("Humanoid")
        if humanoid then
            sethiddenproperty(humanoid, "WalkSpeed", 16)
        end
    end
end)

-- Cleanup
Rayfield:DestroySignal():Connect(function()
    if toggleConnection then
        toggleConnection:Disconnect()
        toggleConnection = nil
    end
    if rainbowConnection then
        rainbowConnection:Disconnect()
    end
    -- Clean up player connections
    for player, connection in pairs(playerConnections) do
        connection:Disconnect()
    end
    playerConnections = {}
end)
